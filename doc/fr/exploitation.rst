============
Exploitation
============

Principes Généraux
------------------

Centreon-newtestd est un daemon Perl chargé de récupérer des indicateurs Newtest. Ce programme utilise le webservice fourni par Newtest afin de se connecter et récupérer les informations d'une (ou plusieurs) console NMC (Newtest Management Console).

Par défaut, « centreon-newtestd » lance un processus et ce processus exécute des sous-processus en fonction de la configuration :

Voici le fonctionnement :

- Un sous-processus est exécuté.
- Le sous-processus récupère les informations de Centreon: les robots et scénarios configurés.
- Le sous-processus récupère la liste des robots et scénarios de la NMC: il les crée dans Centreon avec centreon-clapi (Il ne réalise pas de suppression ou de désactivation dans Centreon).
- Le sous-processus récupère le statut de la NMC: il réalise la mise à jour des services via "centcore".

Centreon-newtestd nécessite impérativement l'utilisation d'une (ou plusieurs) NMC.

.. image:: /images/archi.png

Mode de fonctionnement
----------------------

Le programme « centreon-newtestd » fonctionne uniquement en mode daemon.

Configuration du daemon
---------------------------

Le daemon « centreon-newtestd » possède un fichier de configuration « centreon_newtestd.pm » de la forme suivante ::
 
    %centreon_newtestd_config = (
        1 => { date => '* * * * *', arguments => {
                                                    nmc_endpoint => 'http://__NMC_ADDRESS__/nws/managementconsoleservice.asmx', 
                                                    timeout => 10,
                                                    host_template => 'generic-active-host', host_prefix => 'Robot-%s',
                                                    service_template => 'generic-passive-service', service_prefix => 'Scenario-%s',
                                                    poller_name => 'Central',
                                                    clapi_command => '/usr/share/centreon/www/modules/centreon-clapi/core/centreon', 
                                                    clapi_username => 'admin', clapi_password => 'centreon',
                                                    clapi_action_applycfg => 'POLLERRELOAD',
                                                    ListScenarioStatus => { search => 'All', instances => [] } 
                                                 } },
        2 => { date => '0-59/5 * * * *', arguments => { 
                                                    nmc_endpoint => 'http://__NMC_ADDRESS__/nws/managementconsoleservice.asmx', 
                                                    timeout => 10,
                                                    host_template => 'generic-active-host', host_prefix => 'Robot-%s',
                                                    service_template => 'generic-passive-service', service_prefix => 'Scenario-%s',
                                                    poller_name => 'Central',
                                                    clapi_command => '/usr/share/centreon/www/modules/centreon-clapi/core/centreon', 
                                                    clapi_username => 'admin', clapi_password => 'centreon',
                                                    clapi_action_applycfg => 'POLLERRELOAD',
                                                    ListScenarioStatus => { search => 'Robot', instances => ['XXXX'] } 
                                                  } },
    );

Il est nécessaire de configurer au moins une entrée dans le tableau. Voici la signification des attributs :

- 'date': configure l'ordonnancement des appels NMC (format crontab)
- 'nmc_endpoint': adresse de la NMC
- 'timeout': timeout pour les appels à la NMC
- 'host_template': modèle d'hôte utilisé pour la création des hôtes Centreon
- 'host_prefix': nom utilisé pour la création et la recherche des hôtes Centreon
- 'service_templte': modèle d'hôte utilisé pour la création des services Centreon
- 'service_prefix': nom utilisé pour la création et la recherche des services Centreon
- 'poller_name': collecteur utilisé pour la création des hôtes Centreon
- 'clapi_username' and 'clapi_password': information de connexions pour centreon-clapi 
- 'clapi_action_applycfg': les valeurs possibles sont 'POLLERRELOAD' ou 'POLLERRESTART'
- 'ListScenarioStatus': permet de définir les informations à récupérer de la NMC :
   - L'ensemble des robots: { search => 'All', instances => [] } 
   - Filtre sur des robots: { search => 'Robot', instances => ['XXXX', 'YYYY'] }

Troubleshooting
---------------

Il est possible de retrouver des erreurs de ce type dans les « logs » de « centreon-newtestd » ::

    die: syntax error at line 1, column 0, byte 0 at /usr/lib/perl5/vendor_perl/5.8.8/i386-linux-thread-multi/XML/Parser.pm line 189

Cela signifie un problème de timeout avec la NMC.
